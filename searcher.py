# Import modules
import vulndb
import sqlite3
import config

# Define search vulns function
def search_vulns(db_name):
    # Connect to a SQLite database
    conn = sqlite3.connect(db_name)
    cur = conn.cursor()

    # Create a table for vulnerabilities
    cur.execute("""CREATE TABLE IF NOT EXISTS vulnerabilities (
        ip TEXT,
        port INTEGER,
        service TEXT,
        version TEXT,
        cve TEXT,
        cvss REAL,
        description TEXT,
        solution TEXT,
        PRIMARY KEY (ip, port, cve)
        )""")

    # Query the VulnDB API for vulnerabilities by service and version
    for row in cur.execute("""SELECT ip, port, service, version FROM hosts_services"""):
        ip, port, service, version = row
        vulns = vulndb.search(service, version)
        
        # Insert the vulnerability data into the table
        for vuln in vulns:
            cur.execute("""INSERT OR IGNORE INTO vulnerabilities VALUES (?, ?, ?, ?, ?, ?, ?, ?)""",
                (ip, port, service, version, vuln.cve, vuln.cvss, vuln.description, vuln.solution))

    # Commit changes and close connection
    conn.commit()
    conn.close()